# ============================================
# Release Management â€” FindRepo
# Creates GitHub Releases on version tags
# ============================================

name: Release Management

on:
  push:
    tags: ['v*.*.*']
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Determine tag
        id: tag_info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi

          # Validate tag format
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "::error::Invalid tag format '$TAG'. Expected format: v*.*.*"
            exit 1
          fi

          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Tag: $TAG | Version: $VERSION"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.tag_info.outputs.tag }}

      - name: Generate release notes
        id: notes
        run: |
          cat > RELEASE_NOTES.md << 'HEREDOC'
          ## ðŸ” FindRepo v${{ steps.tag_info.outputs.version }}

          **GitHub Repository Explorer** â€” Search, explore, and discover repositories within any GitHub organization.

          ### ðŸ“¦ What's Included

          | File | Description |
          |------|-------------|
          | `index.html` | Main application page |
          | `style.css` | Complete dark-themed styling |
          | `app.js` | Application logic & GitHub API integration |

          ### ðŸ³ Docker

          ```bash
          # Pull from Docker Hub
          docker pull ${{ github.repository_owner }}/findrepo:${{ steps.tag_info.outputs.version }}

          # Pull from GitHub Packages
          docker pull ghcr.io/${{ github.repository }}/findrepo:${{ steps.tag_info.outputs.version }}

          # Run locally
          docker run -d -p 8080:80 ${{ github.repository_owner }}/findrepo:${{ steps.tag_info.outputs.version }}
          ```

          ### ðŸŒ Quick Start (No Docker)

          ```bash
          # Download the release assets and open in browser
          open index.html

          # Or use any local server
          python3 -m http.server 8000
          npx serve .
          ```

          ### ðŸ”’ Security
          - Your GitHub token is never stored or persisted
          - All API calls go directly to `api.github.com`
          - No analytics, tracking, or third-party scripts
          HEREDOC

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: "FindRepo ${{ steps.tag_info.outputs.tag }}"
          body_path: RELEASE_NOTES.md
          generate_release_notes: true
          append_body: true
          draft: false
          prerelease: ${{ contains(steps.tag_info.outputs.tag, '-rc') || contains(steps.tag_info.outputs.tag, '-beta') || contains(steps.tag_info.outputs.tag, '-alpha') }}
          files: |
            index.html
            style.css
            app.js
            README.md
            Dockerfile
            nginx.conf
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
